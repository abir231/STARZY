<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="Starzy Chat Admin Dashboard">
	<meta name="author" content="Starzy">
	<meta name="keywords" content="starzy, chat, admin, dashboard, management">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="img/icons/icon-48x48.png" />

	<title>Starzy Admin</title>

	<link href="css/app.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
	
	<style>
		:root {
			--primary-color: #9370DB;
			--secondary-color: #BA55D3;
		}
		
		.sidebar {
			background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
		}
		
		.sidebar-header {
			color: rgba(255, 255, 255, 0.5);
		}
		
		.badge-starzy-primary {
			background-color: var(--primary-color);
			color: #fff;
		}
		
		.badge-starzy-warning {
			background-color: #ffc107;
			color: #212529;
		}
		
		.badge-starzy-danger {
			background-color: #dc3545;
			color: #fff;
		}
		
		.btn-starzy {
			background-color: var(--primary-color);
			border-color: var(--primary-color);
			color: #fff;
		}
		
		.btn-starzy:hover {
			background-color: #8A65D7;
			border-color: #8A65D7;
			color: #fff;
		}
		
		.stats-card {
			border-radius: .5rem;
			padding: 1.5rem;
			background-color: #fff;
			box-shadow: 0 0.75rem 1.5rem rgba(18, 38, 63, 0.03);
			margin-bottom: 1.5rem;
			display: flex;
			align-items: center;
		}
		
		.stats-icon {
			width: 48px;
			height: 48px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			margin-right: 1rem;
			font-size: 1.5rem;
		}
		
		.stats-details {
			flex: 1;
		}
		
		.stats-number {
			font-size: 1.5rem;
			font-weight: 600;
			margin-bottom: 0;
		}
		
		.stats-description {
			color: #6c757d;
			margin-bottom: 0;
		}
		
		.icon-discussions {
			background-color: rgba(147, 112, 219, 0.2);
			color: var(--primary-color);
		}
		
		.icon-messages {
			background-color: rgba(23, 162, 184, 0.2);
			color: #17a2b8;
		}
		
		.icon-active {
			background-color: rgba(40, 167, 69, 0.2);
			color: #28a745;
		}
		
		.action-btn {
			margin-right: 5px;
			color: #fff;
			border: none;
			padding: .2rem .5rem;
			border-radius: .2rem;
			cursor: pointer;
			transition: background-color .15s ease-in-out;
		}
		
		.btn-view {
			background-color: #17a2b8;
		}
		
		.btn-edit {
			background-color: #ffc107;
		}
		
		.btn-delete {
			background-color: #dc3545;
		}
	</style>
</head>

<body>
	<div class="wrapper">
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="index.html">
					<span class="align-middle">Starzy Admin</span>
				</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Management
					</li>

					<li class="sidebar-item active">
						<a class="sidebar-link" href="index.html">
							<i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Dashboard</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="../../../controllers/AdminController.php">
							<i class="align-middle" data-feather="message-square"></i> <span class="align-middle">Chat Management</span>
						</a>
					</li>
                    
                    <li class="sidebar-item">
						<a class="sidebar-link" href=" ">
							<i class="align-middle" data-feather="grid"></i> <span class="align-middle">Gestion des patrimoines</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="gestActvt.html">
							<i class="align-middle" data-feather="book"></i> <span class="align-middle">Gestion des activit√©s de patrimoine</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="">
							<i class="align-middle" data-feather="user"></i> <span class="align-middle">Gestion des comptes</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href=" ">
							<i class="align-middle" data-feather="grid"></i> <span class="align-middle">Gestion des evenements</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href=" ">
							<i class="align-middle" data-feather="check-square"></i> <span class="align-middle">Gestion des reclamations</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="../../../views/FrontOffice/designe.php">
							<i class="align-middle" data-feather="home"></i> <span class="align-middle">Back to Website</span>
						</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href=" ">
							<i class="align-middle" data-feather="user-plus"></i> <span class="align-middle">Se deconnecter</span>
						</a>
					</li>
				</ul>
			</div>
		</nav>

		<div class="main">
			<main class="content">
				<div class="container-fluid p-0">

					<h1 class="h3 mb-3"><strong>Starzy Chat</strong> Dashboard</h1>

					<!-- Statistics Cards -->
					<div class="row">
						<div class="col-md-4">
							<div class="stats-card">
								<div class="stats-icon icon-discussions">
									<i data-feather="message-circle"></i>
								</div>
								<div class="stats-details">
									<h3 class="stats-number" id="total-discussions">0</h3>
									<p class="stats-description">Total Discussions</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="stats-card">
								<div class="stats-icon icon-messages">
									<i data-feather="message-square"></i>
								</div>
								<div class="stats-details">
									<h3 class="stats-number" id="total-messages">0</h3>
									<p class="stats-description">Total Messages</p>
								</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="stats-card">
								<div class="stats-icon icon-active">
									<i data-feather="calendar"></i>
								</div>
								<div class="stats-details">
									<h3 class="stats-number" id="recent-discussions">0</h3>
									<p class="stats-description">Discussions This Week</p>
								</div>
							</div>
						</div>
					</div>

					<!-- Recent Discussions Section -->
					<div class="row">
						<div class="col-12 d-flex">
							<div class="card flex-fill">
								<div class="card-header d-flex justify-content-between align-items-center">
									<h5 class="card-title mb-0">Recent Chat Discussions</h5>
									<button class="btn btn-starzy btn-sm" id="refresh-discussions">
										<i data-feather="refresh-cw"></i> Refresh
									</button>
								</div>
								<div class="card-body">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<form class="mb-0">
											<div class="input-group">
												<input type="text" class="form-control" id="search-discussions" placeholder="Search by username...">
												<div class="input-group-append">
													<button class="btn btn-outline-secondary" type="button" id="clear-search">
														<i data-feather="x"></i>
													</button>
												</div>
											</div>
										</form>
										<a href="../../../controllers/AdminController.php" class="btn btn-starzy">
											<i data-feather="external-link"></i> Go to Chat Management
										</a>
									</div>
									<div class="table-responsive">
										<table class="table table-hover my-0" id="discussions-table">
											<thead>
												<tr>
													<th>#ID</th>
													<th>Username</th>
													<th class="d-none d-xl-table-cell">Creation Date</th>
													<th class="d-none d-md-table-cell">User ID</th>
													<th class="d-none d-md-table-cell">Messages</th>
													<th>Actions</th>
												</tr>
											</thead>
											<tbody id="discussions-list">
												<!-- Discussions will be loaded here dynamically -->
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>

			<footer class="footer">
				<div class="container-fluid">
					<div class="row text-muted">
						<div class="col-6 text-start">
							<p class="mb-0">
								<a class="text-muted" href="#"><strong>Starzy Admin</strong></a> &copy;
							</p>
						</div>
						<div class="col-6 text-end">
							<ul class="list-inline">
								<li class="list-inline-item">
									<a class="text-muted" href="#">Support</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Help Center</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Privacy</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="#">Terms</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</footer>
		</div>
	</div>

	<!-- View Discussion Modal -->
	<div class="modal fade" id="viewDiscussionModal" tabindex="-1" role="dialog" aria-labelledby="viewDiscussionModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="viewDiscussionModalLabel">Discussion Details</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<h6 class="mb-1">Username:</h6>
						<p id="view-discussion-username"></p>
					</div>
					<div class="mb-3">
						<h6 class="mb-1">Messages:</h6>
						<div id="view-discussion-messages">
							<!-- Messages will be loaded here -->
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
					<a href="#" id="view-full-discussion" class="btn btn-starzy">View Full Details</a>
				</div>
			</div>
		</div>
	</div>

	<script src="js/app.js"></script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

	<script>
		document.addEventListener("DOMContentLoaded", function() {
			// Initialize Feather icons
			feather.replace();
			
			let allDiscussions = [];
			
			// Load initial statistics
			loadStats();
			
			// Load recent discussions
			loadDiscussions();
			
			// Refresh button
			$('#refresh-discussions').click(function() {
				loadStats();
				loadDiscussions();
			});
			
			// Search discussions
			$('#search-discussions').on('input', function() {
				const searchTerm = $(this).val().toLowerCase();
				if (searchTerm === '') {
					renderDiscussions(allDiscussions);
				} else {
					const filteredDiscussions = allDiscussions.filter(discussion => 
						discussion.nom_user.toLowerCase().includes(searchTerm) || 
						discussion.id_dis.toString().includes(searchTerm)
					);
					renderDiscussions(filteredDiscussions);
				}
			});
			
			// Clear search
			$('#clear-search').click(function() {
				$('#search-discussions').val('');
				renderDiscussions(allDiscussions);
			});
			
			// Function to load statistics
			function loadStats() {
				$.ajax({
					url: '/chaima/controllers/AdminController.php?action=getStats',
					method: 'GET',
					success: function(response) {
						if (response.status === 'success') {
							$('#total-discussions').text(response.data.total_discussions);
							$('#total-messages').text(response.data.total_messages);
							$('#recent-discussions').text(response.data.recent_discussions);
						} else {
							console.error('Error loading statistics');
						}
					},
					error: function() {
						console.error('Error connecting to server');
					}
				});
			}
			
			// Function to load all discussions
			function loadDiscussions() {
				$.ajax({
					url: '/chaima/controllers/LiveController.php?action=getDiscussions',
					method: 'GET',
					success: function(discussions) {
						allDiscussions = discussions;
						renderDiscussions(discussions.slice(0, 10)); // Show only 10 most recent
					},
					error: function() {
						console.error('Error loading discussions');
					}
				});
			}
			
			// Function to load messages for a discussion
			function loadMessages(discussionId) {
				return new Promise((resolve, reject) => {
					$.ajax({
						url: '/chaima/controllers/LiveController.php?action=getMessages',
						method: 'GET',
						data: { discussion_id: discussionId },
						success: function(messages) {
							resolve(messages);
						},
						error: function() {
							console.error('Error loading messages');
							reject([]);
						}
					});
				});
			}
			
			// Function to render discussions in the table
			function renderDiscussions(discussions) {
				const discussionsList = $('#discussions-list');
				discussionsList.empty();
				
				if (discussions.length === 0) {
					discussionsList.html('<tr><td colspan="6" class="text-center">No discussions found</td></tr>');
					return;
				}
				
				discussions.forEach(function(discussion) {
					const date = new Date(discussion.creation_date);
					const formattedDate = date.toLocaleString();
					
					const messageCount = discussion.message_count || 0;
					
					const row = `
						<tr data-id="${discussion.id_dis}">
							<td>${discussion.id_dis}</td>
							<td>${discussion.nom_user}</td>
							<td class="d-none d-xl-table-cell">${formattedDate}</td>
							<td class="d-none d-md-table-cell">${discussion.user_id}</td>
							<td class="d-none d-md-table-cell">${messageCount}</td>
							<td>
								<button class="action-btn btn-view view-discussion" data-id="${discussion.id_dis}" data-name="${discussion.nom_user}">
									<i data-feather="eye" class="feather-sm"></i>
								</button>
								<a href="/chaima/controllers/AdminController.php" class="action-btn btn-edit">
									<i data-feather="edit-2" class="feather-sm"></i>
								</a>
							</td>
						</tr>
					`;
					
					discussionsList.append(row);
				});
				
				// Reinitialize Feather icons for dynamically added content
				feather.replace();
				
				// Add event handlers for the view button
				$('.view-discussion').click(function() {
					const discussionId = $(this).data('id');
					const discussionName = $(this).data('name');
					viewDiscussion(discussionId, discussionName);
				});
			}
			
			// Function to view a discussion in the modal
			async function viewDiscussion(discussionId, discussionName) {
				$('#view-discussion-username').text(discussionName);
				$('#view-full-discussion').attr('href', `/chaima/controllers/AdminController.php?discussion=${discussionId}`);
				
				// Clear previous messages
				$('#view-discussion-messages').html('<div class="text-center"><div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div></div>');
				
				// Show the modal
				$('#viewDiscussionModal').modal('show');
				
				try {
					// Load messages
					const messages = await loadMessages(discussionId);
					renderQuickViewMessages(messages);
				} catch (error) {
					$('#view-discussion-messages').html('<div class="alert alert-danger">Error loading messages</div>');
				}
			}
			
			// Function to render messages in the modal
			function renderQuickViewMessages(messages) {
				const messagesContainer = $('#view-discussion-messages');
				messagesContainer.empty();
				
				if (messages.length === 0) {
					messagesContainer.html('<div class="text-center text-muted">No messages in this discussion</div>');
					return;
				}
				
				// Show only the last 5 messages for quick view
				const recentMessages = messages.slice(-5);
				
				recentMessages.forEach(function(message) {
					const date = new Date(message.date_envoi);
					const formattedDate = date.toLocaleString();
					
					const messageHtml = `
						<div class="mb-2 p-2 border-left border-primary" style="border-left-width: 3px !important;">
							<div class="small text-muted mb-1">
								${formattedDate}
							</div>
							<div>
								${message.raw_message}
							</div>
						</div>
					`;
					
					messagesContainer.append(messageHtml);
				});
				
				if (messages.length > 5) {
					messagesContainer.append(`<div class="text-center mt-2"><em>Showing 5 most recent messages of ${messages.length} total</em></div>`);
				}
			}
		});
	</script>
</body>

</html>